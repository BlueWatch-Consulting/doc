Beispiel ZBW Labs. S. a. [[Git]]

==Development (DEV only)==

===Setup Drupal Repository===

Um nur den Branch 7.x zu tracken:

  [remote "drupal"]
    url = git://drupalcode.org/project/drupal.git
    fetch = +refs/heads/7.x:refs/remotes/drupal/7.x

===Vendor Update Drupal Core===

  git checkout labs   # um sicherzugehen, dass ich auf dem Masterbranch bin
  git fetch -v drupal
  git tag   # Drupal-Versionstag identifizieren, z.B. "7.12"
  # Commit mit generierter Message erzwingen
  git merge --log --no-ff 7.12 -m "Issue LABS-23: Merge Drupal 7.12"
  drush updatedb

  # Update localization
  drush l10n-update-refresh
  drush l10n-update

  # zurück ins Repository
  git push
  git push --tags

===Vendor Update Drupal Modules===

* Überprüfen, dass der Core auf Stand ist!
* Überprüfen, dass es keine nicht commiteten Dateien gibt (Patch-Dateien ggf. sichern)

* Nach verfügbaren Upates suchen:

  drush up -n

* Nach geänderten Files suchen:

  drush hacked-list-projects

* Module einzeln aktualisieren (insbesondere, damit DB-Fehler sofort auffallen und modulweise behoben werden können).

  drush rl # installierte Version checken
  drush dl <module>  # ggf. auf -dev achten
  drush updb

Testen (aufrufbar | fliegt die Seite auseinander | ist editieren möglich? | ggf. auch deploy!)

  git add <path/to/module>
  git commit -m "Upgrade module xyz to 7.x-1.3"
  git push

===Update von separaten (Modul-) Repositories (zenlabs)===

====Aktualisierung zenlabs====

 # update zen (currently dev release used!)
 drush up zen-7.x-5.x-dev 
 
 # prepare old custom theme directory (let git point to the correct branch)
 cd sites/all/themes/custom/zenlabs
 git co 7.x-5.x-STARTERKIT
 
 # move directory out of the way, because drush does not overwrite
 # its contents correctly
 cd ..
 mv -f zenlabs /tmp/zenlabs.bak
 
 # initialize new custom theme directory
 drush zen --path=sites/all/themes/custom --without-rtl "Zen Sub-theme Labs" zenlabs
 
 # hack to put it under git control
 cp -pr /tmp/zenlabs.bak/.git zenlabs
 
 # check in
 git ci -am "New zen subtheme initialized from STARTERKIT 7.x-5.1+111-dev"
 
 # back to main branch
 git checkout 7.x-5.x
 # merge STARTERKIT changes into main branch
 git merge --no-commit 7.x-5.x-STARTERKIT
 # ... solve conflicts
 git commit -m "Merge branch '7.x-5.x-STARTERKIT' (+111-dev) into 7.x-5.x"
 
 # theme zenlabs has been automatically disabled - re-enable
 drush -y en zenlabs

===Merge von issue branch===

  git co labs
  git merge --log --no-ff Issue_LABS-117_drupal-upgrade

===Patches===

====Patch erstellen====

s. a. [https://drupal.org/node/707484 Making a Drupal patch with Git]

* ins Moduldirectory gehen
* Datei(en) ändern
* Patch-Datei erstellen

  git diff > [project_name]-[short-description]-[issue-number]-[comment-number].patch

====Patch anwenden====

s. a. [https://drupal.org/patch/apply Applying patches]

* ins Moduldirectory gehen

 patch -p1 --verbose < path/file.patch

'Nicht' mit git apply ... versuchen - dann wird das git root Verzeichnis angenommen!!

==Deployment==

===Deployment auf Test/QA===

====von DEV====

* Merge von Issue Branches
* ggf. git rebase zur Zusammenfassung von Commits
* zentrales Repository aktualisieren

  git push

====auf QA====

* ggf. händische Sicherung mit 'backup_drupal.sh'
* Update aus dem Repository automatisiert

  update_drupal_inst.sh qalabs

* anhand von Jira die relevanten Issues holen und abarbeiten
* testen ...
* Issues auf resolved setzen
* ''keine Code- oder Konfigurationsänderung auf QA!'' (ggf. Zyklus von DEV aus wiederholen)
* immer

====auf QALIVE====

* ggf. händische Sicherung mit 'backup_drupal.sh'
* Update aus dem Repository automatisiert

  update_drupal_inst.sh qalivelabs

* mindestens ein Deployment testen
* ggf. weitere Issue-spezifische Deployment Tests

====neue Version erzeugen====

* in Git taggen (auf DEV, nicht QA - dort kann es unsinnige Merges geben)

  git tag -a 7.x-1.5 -m "7.x-1.5"
  git push --tags

===Deployment in Produktion===

====auf PROD/STAGE====

  update_drupal_inst.sh labs 7.x-1.5

'''Offen: pull in fetch und merge (mit Meldung) trennen. Wie Meldung zur tatsächlichen Produktivsetzung des Codes erzeugen?'''

====auf PROD/LIVE====

* dito

==Maintenance==

===Aktualisierte Instanz auf anderen Entwicklungsrechner übertragen===

* Überprüfen, dass es keine nicht commiteten Dateien gibt.
  
  git pull   # macht einen ff-merge ohne commit/log-Eintrag!
  # Schema Cache löschen
  drush ev "cache_clear_all('schema:', 'cache', TRUE);"
  # Schemaänderungen aus der neuen Version nachziehen
  drush updatedb

===Neue Instanz (z.B. QA) aufsetzen===

Postgres und [[PHP Installation|PHP aktualisieren]] (postgresql als DB erfordert php53!)

Neue Datenbank

  su - postgres
  createdb drupal_labs (oder ggf. drupal_qalabs)
  exit

Drupal-DB-User ggf. anlegen und berechtigen

  su - postgres
  psql
    create user drupaladmin with password 'geheim';
    grant all privileges on database drupal_labs to drupaladmin;
    \q
  exit

Verzeichnis (für qalabs)

  cd /opt
  git clone user@server:/srv/git/labs.git qalabs
  # bzw. in DMZ: git clone ssh://user@server:4712/srv/git/labs.git qalabs

Link für Apache

  cd /var/www/html
  ln -s ../../../opt/labs

Apachekonfiguration (Multiviews wird für multilingual gebraucht)

  s. labs.conf

====Initialisierung neue DEV DB====

Interaktive Installation über Browser (/labs)

- oder -

Installation mit drush
  
  cd /opt/drupaldev
  # settings.php wird vorausgesetzt
  chmod 666 sites/default/settings.php
  mkdir -p sites/default/files
  chmod 777 sites/default/files
  # Datenbank wird im Folgeschritt komplett gelöscht und neu aufgebaut
  drush site-install standard --site-name=drupaldev

Für Drupal-Development allgemein

  drush -y dis overlay dashboard
  drush dl devel coder examples security_review hacked
  drush -y en simpletest devel coder coder_review
  drush -y updb

Spezifisch für web_taxonmy

  drush dl ctools http_client web_taxonomy
  drush -y en ctools http_client web_taxonomy
  drush -y updb

Erstkonfiguration für labs

  Module Locale und Features aktivieren
  Sprache Deutsch hinzufügen
  Prefix "en" für Sprache en definieren
  Feature labs aktivieren

====mit DB-Inhalt von anderem System starten====

System-Vorbereitung

  Postgres-Port in iptables freigeben (falls das System nicht durch DMZ-Einstellungen blockiert wird)

Dateien und Verzeichnis für Drupal-Konfig

  # settings.php von anderem Rechner übernehmen  
  cd /opt/qalabs
  vi sites/default/settings.php # site_name und DB-Verbindung setzen
  chown :apache sites/default/settings.php
  chmod 664 sites/default/settings.php
  mkdir sites/default/files
  chown :apache sites/default/files
  chmod 775 sites/default/files
  chcon -vt httpd_sys_content_t './files'  # auf SElinux-Systemen

DBTNG-Migrator Prozedur (in replicate_labs_to_demo.sh) produziert Fehler:

 SQLSTATE[42703]: Undefined column: 7 ERROR:  column "i18n_mode" of   [error]
 relation "block" does not exist at character 112
 SQLSTATE[42703]: Undefined column: 7 ERROR:  column "l10n_status" of [error]
 relation "locales_target" does not exist at character 71
 SQLSTATE[42703]: Undefined column: 7 ERROR:  column "i18n_mode" of   [error]
 relation "menu_custom" does not exist at character 57
 SQLSTATE[42703]: Undefined column: 7 ERROR:  column "language" of    [error]
 relation "menu_links" does not exist at character 215
 SQLSTATE[42703]: Undefined column: 7 ERROR:  column "language" of    [error]
 relation "taxonomy_term_data" does not exist at character 78
 SQLSTATE[42703]: Undefined column: 7 ERROR:  column "language" of    [error]
 relation "taxonomy_vocabulary" does not exist at character 99

daher 
:auf Quellsystem

  pg_dump -U postgres drupal_labs > /tmp/drupal_labs.sql
  scp /tmp/drupal_labs.sql ite-srv11:/tmp

:auf Zielsystem

  psql drupal_labs < /tmp/drupal_labs.sql

==Drupal Installation==

===Drupal Core===

* für Projekt lokales Git-Repository als Clone von Drupal Core anlegen
  cd /opt
  git clone http://git.drupal.org/project/drupal.git labs
* verfügbare Tags anzeigen
  git tag
* aktuellste Version aktivieren
  git checkout 7.9
* das Projekt-Repository als zentrales setzen
  git remote rename origin drupal
  remote add origin ssh://user@server/srv/git/labs.git
* Projekt-Branch anlegen
  checkout -b labs
* in das zentrale Projekt-Repository laden
  git push origin labs
* Name+Email setzen
  git config --global user.name "Joachim Neubert"
  git config --global user.email "j.neubert@zbw.eu"
* ggf. farbige Anzeige setzen
  git config --global  color.ui "auto"

===drush===

* mit Git installieren

  cd /opt
  git clone --branch 7.x-4.x http://git.drupal.org/project/drush.git
  cd /usr/local/bin
  ln -s /opt/drush/drush

==Weblinks==

* [http://www.vogella.de/articles/Git/article.html Git Tutorial]
